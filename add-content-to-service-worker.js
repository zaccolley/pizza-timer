// Adds two variables to the service-worker file
// INJECTED_VERSION: The version from the package.json
// INJECTED_FILE_PATHS: The files generated by Webpack

console.info('\nAdding variables to built service-worker.js file.\n');

const prependFile = require('prepend-file');
const stats = require('./build/stats.json');
const packageJson = require('./package.json');

const STATIC_PATHS = [
  'favicon.ico',
  'manifest.json'
];

const generatedFilePaths = stats.assets.map(asset => asset.name).filter(file => {
  const inAssetsFolder = file.startsWith('assets/');
  const isntServiceWorker = !file.includes('service-worker.js');
  const isJavaScriptFile = file.endsWith('.js');
  const isCSSFile = file.endsWith('.css');

  return isntServiceWorker && (inAssetsFolder || isJavaScriptFile || isCSSFile);
});

const injectedFilePathsString = generatedFilePaths.concat(STATIC_PATHS)
  .sort()
  .map(filePath => `  "/${filePath}"`)
  .join(',\n');

const codeToPrepend = `
const INJECTED_VERSION = "${packageJson.version}";
const INJECTED_FILE_PATHS = [
${injectedFilePathsString}
];
`.trim() + "\n";

prependFile('build/service-worker.js', codeToPrepend, (err) => {
  if (err) {
    console.error('Something went wrong adding variables to service-worker.js', err);
  }
});